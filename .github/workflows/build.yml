name: Build Opus Tools (Refactored)

on:
  schedule:
    - cron: '32 18 15 * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}

jobs:
  check-get-versions:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      flac_sha: ${{ steps.check.outputs.flac_sha }}
      ogg_sha: ${{ steps.check.outputs.ogg_sha }}
      opus_sha: ${{ steps.check.outputs.opus_sha }}
      libopusenc_sha: ${{ steps.check.outputs.libopusenc_sha }}
      opusfile_sha: ${{ steps.check.outputs.opusfile_sha }}
      opus_tools_sha: ${{ steps.check.outputs.opus_tools_sha }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Check Updates & Get Versions
        id: check
        run: python .github/scripts/check_updates.py

  generate-docs:
    needs: check-get-versions
    if: needs.check-get-versions.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Opus
        run: |
          git clone https://github.com/xiph/opus.git
          cd opus
          git checkout ${{ needs.check-get-versions.outputs.opus_sha }}

      - name: Install Documentation Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz pandoc npm autoconf automake libtool
          sudo npm install -g moxygen

      - name: Configure and Generate Docs
        run: |
          cd opus
          ./autogen.sh
          ./configure --enable-doc
          
          # Enable XML generation for Moxygen (append to generated Doxyfile)
          echo "GENERATE_XML = YES" >> doc/Doxyfile
          
          # Build docs
          cd doc
          doxygen Doxyfile
          
          # Generate Markdown
          moxygen xml --no-index --anchors --output opus_api.md
          
          # Generate Text
          pandoc opus_api.md -f markdown -t plain -o opus_api.txt

      - name: Upload Documentation
        uses: actions/upload-artifact@v4
        with:
          name: opus-api-docs
          path: |
            opus/doc/html
            opus/doc/opus_api.md
            opus/doc/opus_api.txt

  build-dependencies:
    needs: check-get-versions
    if: needs.check-get-versions.outputs.should_run == 'true'
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        type: [static, shared]
        group: [flac-deps, opus-deps]
    steps:
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            git
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-autotools
            mingw-w64-x86_64-gcc

      - name: Clone Dependencies
        shell: bash
        env:
          FLAC_SHA: ${{ needs.check-get-versions.outputs.flac_sha }}
          OGG_SHA: ${{ needs.check-get-versions.outputs.ogg_sha }}
          OPUS_SHA: ${{ needs.check-get-versions.outputs.opus_sha }}
          LIBOPUSENC_SHA: ${{ needs.check-get-versions.outputs.libopusenc_sha }}
          OPUSFILE_SHA: ${{ needs.check-get-versions.outputs.opusfile_sha }}
        run: |
          mkdir -p build_work
          cd build_work
          
          # Clone Ogg (common)
          echo "Cloning Ogg ($OGG_SHA)..."
          git clone https://github.com/xiph/ogg.git ogg
          cd ogg && git checkout $OGG_SHA && cd ..
          
          if [ "${{ matrix.group }}" == "flac-deps" ]; then
            echo "Cloning FLAC ($FLAC_SHA)..."
            git clone https://github.com/xiph/flac.git flac
            cd flac && git checkout $FLAC_SHA && cd ..
          elif [ "${{ matrix.group }}" == "opus-deps" ]; then
            echo "Cloning Opus ($OPUS_SHA)..."
            git clone https://github.com/xiph/opus.git opus
            cd opus && git checkout $OPUS_SHA && cd ..
            
            echo "Cloning Libopusenc ($LIBOPUSENC_SHA)..."
            git clone https://github.com/xiph/libopusenc.git libopusenc
            cd libopusenc && git checkout $LIBOPUSENC_SHA && cd ..
            
            echo "Cloning Opusfile ($OPUSFILE_SHA)..."
            git clone https://github.com/xiph/opusfile.git opusfile
            cd opusfile && git checkout $OPUSFILE_SHA && cd ..
          fi

      - name: Build Dependencies
        shell: msys2 {0}
        run: |
          export PREFIX="$(pwd)/install_dir"
          mkdir -p $PREFIX
          export PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig"
          export CPPFLAGS="-I$PREFIX/include"
          export LDFLAGS="-L$PREFIX/lib"
          
          # Configure flags
          if [ "${{ matrix.type }}" == "static" ]; then
            CONF_FLAGS="--enable-static --disable-shared"
            CMAKE_FLAGS="-DBUILD_SHARED_LIBS=OFF"
          else
            CONF_FLAGS="--disable-static --enable-shared"
            CMAKE_FLAGS="-DBUILD_SHARED_LIBS=ON"
          fi
          
          cd build_work
          
          # Build Ogg
          echo "Building Ogg..."
          cd ogg
          ./autogen.sh
          ./configure --prefix=$PREFIX $CONF_FLAGS
          make -j$(nproc)
          make install
          cd ..
          
          if [ "${{ matrix.group }}" == "flac-deps" ]; then
            echo "Building FLAC..."
            cd flac
            cmake -S . -B build -G "MSYS Makefiles" -DCMAKE_INSTALL_PREFIX=$PREFIX $CMAKE_FLAGS -DBUILD_PROGRAMS=OFF -DBUILD_TESTING=OFF -DINSTALL_MANPAGES=OFF -DWITH_OGG=ON -DOGG_ROOT=$PREFIX
            cmake --build build -- -j$(nproc)
            cmake --build build --target install
            cd ..
          elif [ "${{ matrix.group }}" == "opus-deps" ]; then
            for repo in opus libopusenc opusfile; do
              echo "Building $repo..."
              cd $repo
              ./autogen.sh
              EXTRA_FLAGS=""
              if [ "$repo" == "opusfile" ]; then EXTRA_FLAGS="--disable-http"; fi
              ./configure --prefix=$PREFIX $CONF_FLAGS $EXTRA_FLAGS
              make -j$(nproc)
              make install
              cd ..
            done
          fi

      - name: Package Dependencies
        run: |
          7z a deps-${{ matrix.group }}-${{ matrix.type }}.zip ./install_dir/*

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deps-${{ matrix.group }}-${{ matrix.type }}
          path: deps-${{ matrix.group }}-${{ matrix.type }}.zip
          retention-days: 1

  build-opus-tools:
    needs: [check-get-versions, build-dependencies]
    if: needs.check-get-versions.outputs.should_run == 'true'
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        type: [static, shared]
    steps:
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
             base-devel
             git
             mingw-w64-x86_64-toolchain
             mingw-w64-x86_64-autotools
             mingw-w64-x86_64-cmake

      - name: Download Dependencies (FLAC)
        uses: actions/download-artifact@v4
        with:
          name: deps-flac-deps-${{ matrix.type }}
          path: .

      - name: Download Dependencies (Opus)
        uses: actions/download-artifact@v4
        with:
          name: deps-opus-deps-${{ matrix.type }}
          path: .

      - name: Extract Dependencies
        run: |
          7z x deps-flac-deps-${{ matrix.type }}.zip -o"./install_dir" -y
          7z x deps-opus-deps-${{ matrix.type }}.zip -o"./install_dir" -y

      - name: Build Opus-Tools
        shell: msys2 {0}
        env:
          OPUS_TOOLS_SHA: ${{ needs.check-get-versions.outputs.opus_tools_sha }}
        run: |
          export PREFIX="$(pwd)/install_dir"
          export PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig"
          
          # Configure flags
          if [ "${{ matrix.type }}" == "static" ]; then
             CONF_FLAGS="--enable-static --disable-shared"
             export PKG_CONFIG="pkg-config --static"
             export LDFLAGS="-L$PREFIX/lib -static"
             export CFLAGS="-O2 -static-libgcc -static-libstdc++ -I$PREFIX/include -DFLAC__NO_DLL -Dfopen_utf8=opus_fopen_utf8 -Dunlink_utf8=opus_unlink_utf8"
          else
             CONF_FLAGS="--disable-static --enable-shared"
             export LDFLAGS="-L$PREFIX/lib"
             export CFLAGS="-O2 -I$PREFIX/include -Dfopen_utf8=opus_fopen_utf8 -Dunlink_utf8=opus_unlink_utf8"
          fi

          echo "Cloning Opus Tools ($OPUS_TOOLS_SHA)..."
          rm -rf src
          git clone https://github.com/xiph/opus-tools.git src
          cd src
          git checkout $OPUS_TOOLS_SHA
          
          ./autogen.sh
          ./configure --prefix=$PREFIX $CONF_FLAGS --with-flac
          make -j$(nproc)
          
          # Prepare release
          mkdir ../release
          cp *.exe ../release/
          
          # Copy DLLs if shared
          if [ "${{ matrix.type }}" == "shared" ]; then
            cp $PREFIX/bin/*.dll ../release/ || true
          fi

      - name: Package Opus Tools
        run: |
          cd release
          7z a ../opus-tools-${{ matrix.type }}.zip *

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: opus-tools-${{ matrix.type }}
          path: opus-tools-${{ matrix.type }}.zip
          retention-days: 1

  update-versions:
    needs: [check-get-versions, build-opus-tools]
    if: needs.check-get-versions.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
           python-version: '3.x'

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: opus-tools-*
          merge-multiple: true
          path: release_assets

      - name: Update upstream-version.json & Generate Notes
        env:
          SHA_FLAC: ${{ needs.check-get-versions.outputs.flac_sha }}
          SHA_OGG: ${{ needs.check-get-versions.outputs.ogg_sha }}
          SHA_OPUS: ${{ needs.check-get-versions.outputs.opus_sha }}
          SHA_LIBOPUSENC: ${{ needs.check-get-versions.outputs.libopusenc_sha }}
          SHA_OPUSFILE: ${{ needs.check-get-versions.outputs.opusfile_sha }}
          SHA_OPUS_TOOLS: ${{ needs.check-get-versions.outputs.opus_tools_sha }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
           python .github/scripts/update_versions.py

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/upstream-version.json
          git commit -m "Update upstream-version.json [skip ci]" || echo "No changes to commit"
          git push

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: release_assets/*.zip
          tag_name: build-${{ needs.check-get-versions.outputs.opus_tools_sha }}
          body_path: release_notes.md

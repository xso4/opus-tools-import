name: Build Windows Static/Shared Binary

on:
  schedule:
    - cron: '32 18 15 * *'
  workflow_dispatch:

permissions:
  contents: write
env:
  DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check_updates.outputs.should_run }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Check for updates
        id: check_updates
        run: python .github/scripts/check_updates.py

  build-deps-flac:
    needs: check
    if: needs.check.outputs.should_run == 'true'
    runs-on: windows-latest
    outputs:
      sha_flac: ${{ steps.ver.outputs.flac }}
      sha_ogg: ${{ steps.ver.outputs.ogg }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            git
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-autotools
            mingw-w64-x86_64-gcc

      - name: Read Versions & Export Variables
        id: ver
        shell: bash
        run: |
          eval "$(python - <<'PY'
          import json
          d = json.load(open('.github/upstream-version.json'))["repositories"]
          repos = ["ogg", "flac"]
          for r in repos:
              url = d[r]["url"]
              key = r.upper().replace("-", "_") + "_URL"
              print(f'{key}="{url}"')
          PY
          )"
          mkdir -p build_work
          cd build_work
          
          for repo in ogg flac; do
             url_var=$(echo "${repo^^}_URL" | tr '-' '_')
             url="${!url_var}"
             echo "Cloning $repo from $url..."
             git clone "$url" "$repo"
             cd $repo
             FULL_SHA=$(git rev-parse HEAD)
             echo "$repo=$FULL_SHA" >> "$GITHUB_OUTPUT"
             cd ..
          done

      - name: Build Dependencies (FLAC)
        shell: msys2 {0}
        run: |
          build_variant() {
            VARIANT=$1
            if [ "$VARIANT" == "static" ]; then
              export PREFIX="$(pwd)/install_dir_static"
              export CFLAGS="-O2 -static-libgcc -static-libstdc++"
              export CXXFLAGS="-O2 -static-libgcc -static-libstdc++"
              CONF_ARGS="--enable-static --disable-shared"
              CMAKE_ARGS="-DBUILD_SHARED_LIBS=OFF"
            else
              export PREFIX="$(pwd)/install_dir_shared"
              export CFLAGS="-O2"
              export CXXFLAGS="-O2"
              CONF_ARGS="--disable-static --enable-shared"
              CMAKE_ARGS="-DBUILD_SHARED_LIBS=ON"
            fi
            
            export PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig"
            export CPPFLAGS="-I$PREFIX/include"
            export LDFLAGS="-L$PREFIX/lib"
            mkdir -p $PREFIX
            
            # Ogg
            echo "Building Ogg ($VARIANT)..."
            cd ogg
            git clean -fdx
            ./autogen.sh
            ./configure --prefix=$PREFIX $CONF_ARGS
            make -j$(nproc)
            make install
            cd ..
            
            # FLAC
            echo "Building FLAC ($VARIANT)..."
            cd flac
            git clean -fdx
            cmake -S . -B build -G "MSYS Makefiles" -DCMAKE_INSTALL_PREFIX=$PREFIX $CMAKE_ARGS -DBUILD_PROGRAMS=OFF -DBUILD_TESTING=OFF -DINSTALL_MANPAGES=OFF -DWITH_OGG=ON -DOGG_ROOT=$PREFIX
            cmake --build build -- -j$(nproc)
            cmake --build build --target install
            cd ..
          }
          
          cd build_work
          build_variant static
          build_variant shared

      - name: Package Dependencies
        shell: bash
        run: |
          cd build_work/install_dir_static && 7z a ../../deps-flac-static.zip *
          cd ../install_dir_shared && 7z a ../../deps-flac-shared.zip *

      - name: Upload Dependencies Static
        uses: actions/upload-artifact@v4
        with:
          name: build-deps-flac-static
          path: deps-flac-static.zip
          retention-days: 1
          
      - name: Upload Dependencies Shared
        uses: actions/upload-artifact@v4
        with:
          name: build-deps-flac-shared
          path: deps-flac-shared.zip
          retention-days: 1

  build-deps-opus:
    needs: check
    if: needs.check.outputs.should_run == 'true'
    runs-on: windows-latest
    outputs:
      sha_opus: ${{ steps.ver.outputs.opus }}
      sha_libopusenc: ${{ steps.ver.outputs.libopusenc }}
      sha_opusfile: ${{ steps.ver.outputs.opusfile }}
      short_sha_opus: ${{ steps.ver.outputs.short_opus }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            git
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-autotools
            mingw-w64-x86_64-gcc

      - name: Read Versions & Export Variables
        id: ver
        shell: bash
        run: |
          eval "$(python - <<'PY'
          import json
          d = json.load(open('.github/upstream-version.json'))["repositories"]
          repos = ["ogg", "opus", "libopusenc", "opusfile"]
          for r in repos:
              url = d[r]["url"]
              key = r.upper().replace("-", "_") + "_URL"
              print(f'{key}="{url}"')
          PY
          )"
          mkdir -p build_work
          cd build_work
          
          for repo in ogg opus libopusenc opusfile; do
             url_var=$(echo "${repo^^}_URL" | tr '-' '_')
             url="${!url_var}"
             echo "Cloning $repo from $url..."
             git clone "$url" "$repo"
             cd $repo
             FULL_SHA=$(git rev-parse HEAD)
             SHORT_SHA=${FULL_SHA:0:7}
             echo "$repo=$FULL_SHA" >> "$GITHUB_OUTPUT"
             if [ "$repo" = "opus" ]; then
                echo "short_opus=$SHORT_SHA" >> "$GITHUB_OUTPUT"
             fi
             cd ..
          done

      - name: Build Dependencies (Opus & Others)
        shell: msys2 {0}
        run: |
          build_variant() {
            VARIANT=$1
            if [ "$VARIANT" == "static" ]; then
              export PREFIX="$(pwd)/install_dir_static"
              export CFLAGS="-O2 -static-libgcc -static-libstdc++"
              export CXXFLAGS="-O2 -static-libgcc -static-libstdc++"
              CONF_ARGS="--enable-static --disable-shared"
            else
              export PREFIX="$(pwd)/install_dir_shared"
              export CFLAGS="-O2"
              export CXXFLAGS="-O2"
              CONF_ARGS="--disable-static --enable-shared"
            fi
            
            export PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig"
            export CPPFLAGS="-I$PREFIX/include"
            export LDFLAGS="-L$PREFIX/lib"
            mkdir -p $PREFIX
            
            # Ogg
            echo "Building Ogg ($VARIANT)..."
            cd ogg
            git clean -fdx
            ./autogen.sh
            ./configure --prefix=$PREFIX $CONF_ARGS
            make -j$(nproc)
            make install
            cd ..
            
            # Opus
            echo "Building Opus ($VARIANT)..."
            cd opus
            git clean -fdx
            ./autogen.sh
            ./configure --prefix=$PREFIX $CONF_ARGS
            make -j$(nproc)
            make install
            cd ..
            
            # Libopusenc
            echo "Building Libopusenc ($VARIANT)..."
            cd libopusenc
            git clean -fdx
            ./autogen.sh
            ./configure --prefix=$PREFIX $CONF_ARGS
            make -j$(nproc)
            make install
            cd ..
            
            # Opusfile
            echo "Building Opusfile ($VARIANT)..."
            cd opusfile
            git clean -fdx
            ./autogen.sh
            ./configure --prefix=$PREFIX $CONF_ARGS --disable-http
            make -j$(nproc)
            make install
            cd ..
          }
          
          cd build_work
          build_variant static
          build_variant shared

      - name: Package Dependencies
        shell: bash
        run: |
          cd build_work/install_dir_static && 7z a ../../deps-opus-static.zip *
          cd ../install_dir_shared && 7z a ../../deps-opus-shared.zip *

      - name: Upload Dependencies Static
        uses: actions/upload-artifact@v4
        with:
          name: build-deps-opus-static
          path: deps-opus-static.zip
          retention-days: 1
          
      - name: Upload Dependencies Shared
        uses: actions/upload-artifact@v4
        with:
          name: build-deps-opus-shared
          path: deps-opus-shared.zip
          retention-days: 1

  build-tools:
    needs: [check, build-deps-flac, build-deps-opus]
    if: needs.check.outputs.should_run == 'true'
    runs-on: windows-latest
    strategy:
      matrix:
        build_type: [static, shared]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          
      - name: Clone upstream source
        shell: powershell
        run: |
          $ls = git ls-remote --symref https://github.com/xiph/opus-tools.git HEAD
          $refLine = ($ls -split "`n" | Where-Object { $_ -match '^ref: refs/heads/' })
          if (-not $refLine) { Write-Error "Failed to detect upstream default branch"; exit 1 }
          $upstreamBranch = ($refLine -replace '^ref: refs/heads/','' -replace '\s+HEAD$','').Trim()
          
          # 删除本地自带的 src 目录，确保克隆到干净的 src
          if (Test-Path "src") { Remove-Item -Recurse -Force src }
          git clone --branch $upstreamBranch https://github.com/xiph/opus-tools.git src

      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            git
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-autotools
            groff
            util-linux

      - name: Download Dependencies (FLAC)
        uses: actions/download-artifact@v4
        with:
          name: build-deps-flac-${{ matrix.build_type }}
          path: .

      - name: Download Dependencies (Opus)
        uses: actions/download-artifact@v4
        with:
          name: build-deps-opus-${{ matrix.build_type }}
          path: .

      - name: Extract Dependencies
        run: |
          7z x deps-flac-${{ matrix.build_type }}.zip -o"./install_dir" -y
          7z x deps-opus-${{ matrix.build_type }}.zip -o"./install_dir" -y

      - name: Build Opus-Tools
        shell: msys2 {0}
        env:
          BUILD_TYPE: ${{ matrix.build_type }}
        run: |
          export PREFIX="$(pwd)/install_dir"
          export PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig"
          
          if [ "$BUILD_TYPE" == "static" ]; then
            export PKG_CONFIG="pkg-config --static"
            export CFLAGS="-O2 -static-libgcc -static-libstdc++ -I$PREFIX/include -DFLAC__NO_DLL -Dfopen_utf8=opus_fopen_utf8 -Dunlink_utf8=opus_unlink_utf8"
            export LDFLAGS="-L$PREFIX/lib -static"
            CONF_ARGS="--enable-static --disable-shared"
          else
            export PKG_CONFIG="pkg-config"
            export CFLAGS="-O2 -I$PREFIX/include -Dfopen_utf8=opus_fopen_utf8 -Dunlink_utf8=opus_unlink_utf8"
            export LDFLAGS="-L$PREFIX/lib"
            CONF_ARGS="--disable-static --enable-shared"
          fi
          
          cd src
          ./autogen.sh
          git reset --hard
          ./configure --prefix=$PREFIX $CONF_ARGS --with-flac
          
          make -j$(nproc)
          
          ls -l *.exe
          
          mkdir ../release
          cp opusenc.exe ../release/
          cp opusdec.exe ../release/
          cp opusinfo.exe ../release/
          
          if [ "$BUILD_TYPE" == "shared" ]; then
             cp $PREFIX/bin/*.dll ../release/
          fi

      - name: Install Documentation Tools
        shell: powershell
        run: |
          choco install pandoc --no-progress
          choco install wkhtmltopdf --no-progress
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

      - name: Generate Documentation
        shell: powershell
        run: |
          $outDir = Join-Path $pwd "release"
          Get-ChildItem -Path "src\man\*.1" | ForEach-Object {
            $base = $_.BaseName
            $source = $_.FullName
            Write-Host "Processing $source..."
            pandoc $source -f man -t html -s -o (Join-Path $outDir "$base.html")
            pandoc $source -f man -t plain -o (Join-Path $outDir "$base.txt")
            pandoc $source -f man -o (Join-Path $outDir "$base.pdf") --pdf-engine=wkhtmltopdf
            pandoc $source -f man -t markdown -s -o (Join-Path $outDir "$base.md")
          }

      - name: Get Versions & Create Package
        id: pkg
        shell: bash
        run: |
          cd src
          OPUS_TOOLS_SHA=$(git rev-parse HEAD)
          OPUS_TOOLS_SHORT=${OPUS_TOOLS_SHA:0:7}
          cd ..
          
          SHA_OPUS="${{ needs.build-deps-opus.outputs.short_sha_opus }}"
          SHA_OPUS=${SHA_OPUS:0:7}
          
          DATE=$(date +'%Y-%m-%d_%H-%M')
          ZIP_NAME="opus-tools-${OPUS_TOOLS_SHORT}_opus-${SHA_OPUS}-${{ matrix.build_type }}.zip"
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "TAG_NAME=${DATE}_${OPUS_TOOLS_SHORT}" >> $GITHUB_ENV
          echo "SHA_OPUS_TOOLS=$OPUS_TOOLS_SHA" >> $GITHUB_ENV
          
          cd release
          7z a "../$ZIP_NAME" *

      - name: Update upstream-version.json & Generate Notes
        env:
          SHA_OPUS: ${{ needs.build-deps-opus.outputs.sha_opus }}
          SHA_FLAC: ${{ needs.build-deps-flac.outputs.sha_flac }}
          SHA_OGG: ${{ needs.build-deps-flac.outputs.sha_ogg }}
          SHA_LIBOPUSENC: ${{ needs.build-deps-opus.outputs.sha_libopusenc }}
          SHA_OPUSFILE: ${{ needs.build-deps-opus.outputs.sha_opusfile }}
          SHA_OPUS_TOOLS: ${{ env.SHA_OPUS_TOOLS }}
        run: |
          python .github/scripts/update_versions.py

      - name: Commit and Push upstream-version.json
        if: matrix.build_type == 'static'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/upstream-version.json
          git commit -m "Update upstream-version.json [skip ci]" || echo "No changes to commit"
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git push origin ${{ env.DEFAULT_BRANCH }}

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ZIP_NAME }}
          tag_name: ${{ env.TAG_NAME }}
          body_path: release_notes.md
